<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ ªã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.bootstrap5.min.css">
    
    <style>
        body { background-color: #f0f2f5; padding: 10px; font-size: 0.85rem; }
        .container-custom { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .header-area { display: flex; align-items: baseline; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .update-date { font-size: 0.8rem; color: #6c757d; }
        .filter-panel { border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .search-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; padding: 10px; }
        .search-item label { font-weight: bold; margin-bottom: 2px; font-size: 0.75rem; color: #444; }
        
        /* å›ºå®šåˆ—ã®å½± */
        .dtfc-fixed-left {
            background-color: #fff !important;
            box-shadow: 4px 0 8px rgba(0,0,0,0.1);
            z-index: 4;
            border-right: 1px solid #dee2e6 !important;
        }

        #stockTable thead th { background-color: #212529 !important; color: #ffffff !important; white-space: nowrap; z-index: 5; text-align: center; }
        .stock-link { color: #0d6efd; text-decoration: none; font-weight: bold; }
        th, td { white-space: nowrap; border-bottom: 1px solid #dee2e6 !important; }
        .loading { text-align: center; padding: 50px; }
        .company-name-cell { display: inline-block; white-space: nowrap; }
        @media (max-width: 767px) {
            .company-name-cell { max-width: 4.5em; overflow: hidden; text-overflow: ellipsis; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div class="container-custom">
    <div class="header-area">
        <h5 class="text-dark fw-bold m-0">ğŸ“‰ æ—¥æœ¬æ ªã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼</h5>
        <span id="lastUpdate" class="update-date">èª­è¾¼ä¸­...</span>
    </div>

    <div class="filter-panel">
        <div class="accordion" id="filterAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters">
                        ğŸ” çµã‚Šè¾¼ã¿æ¡ä»¶ãƒ»è¡¨ç¤ºé …ç›®
                    </button>
                </h2>
                <div id="collapseFilters" class="accordion-collapse collapse">
                    <div class="accordion-body p-0">
                        <div id="searchInputs" class="search-grid"></div>
                        <div class="p-3 border-top bg-light text-end">
                            <div id="columnToggles" class="d-flex flex-wrap gap-1 mb-3 text-start"></div>
                            <button class="btn btn-outline-danger btn-sm" onclick="clearFilters()">ãƒªã‚»ãƒƒãƒˆ</button>
                            <button class="btn btn-success btn-sm ms-2" onclick="copyURL()">å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading"><div class="spinner-border text-primary"></div></div>

    <div id="tableWrapper" style="display:none;">
        <table id="stockTable" class="table table-hover table-bordered w-100 mb-0">
            <thead><tr id="tableHeader"></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const CSV_URL = 'https://aizumi.github.io/finance-lab/screening/jp_combined.csv';
const PERCENT_COLS = ['é…å½“åˆ©å›ã‚Š', 'ROE', 'è‡ªå·±è³‡æœ¬æ¯”ç‡', 'å–¶æ¥­åˆ©ç›Šç‡', 'ç´”åˆ©ç›Šç‡', 'ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¯”ç‡'];
const OKU_COLS = ['æ™‚ä¾¡ç·é¡', 'å£²ä¸Šé«˜', 'å–¶æ¥­åˆ©ç›Š', 'å½“æœŸç´”åˆ©ç›Š', 'è² å‚µ', 'æµå‹•è² å‚µ', 'æµå‹•è³‡ç”£', 'ç·è² å‚µ', 'ç¾é‡‘åŠã³ç¾é‡‘åŒç­‰ç‰©', 'æŠ•è³‡æœ‰ä¾¡è¨¼åˆ¸', 'ãƒãƒƒãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥'];
const SELECT_COLS = ['æ¥­ç¨®', 'å„ªå…ˆå¸‚å ´', 'éƒ½é“åºœçœŒ'];
const TEXT_SEARCH_COLS = ['ä¼šç¤¾å', 'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰'];
const INITIAL_VISIBLE = ['ä¼šç¤¾å', 'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰', 'æ¥­ç¨®', 'æ™‚ä¾¡ç·é¡', 'PBR', 'PER(ä¼šäºˆ)', 'é…å½“åˆ©å›ã‚Š'];

let table;

fetch(CSV_URL, { method: 'HEAD' }).then(res => {
    const lm = res.headers.get('Last-Modified');
    if (lm) $('#lastUpdate').text('æœ€çµ‚æ›´æ–°ï¼š' + new Date(lm).toLocaleString());
});

$.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    let match = true;
    $('#searchInputs .search-item[data-type="range"]').each(function() {
        const colIdx = $(this).data('col-idx');
        const min = parseFloat($(this).find('.min-input').val());
        const max = parseFloat($(this).find('.max-input').val());
        const val = parseFloat(data[colIdx]) || 0;
        if (!isNaN(min) && val < min) match = false;
        if (!isNaN(max) && val > max) match = false;
    });
    return match;
});

Papa.parse(CSV_URL, {
    download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
    complete: function(results) { initApp(results); }
});

function initApp(results) {
    let headers = results.meta.fields.filter(h => h !== 'å¸‚å ´ã‚¿ã‚¤ãƒ—');
    let data = results.data.map(row => {
        let newRow = {};
        headers.forEach(h => {
            let val = row[h];
            if (h === 'æ±ºç®—æœˆ' && val) {
                const m = new Date(val).getMonth() + 1;
                val = isNaN(m) ? val : m + "æœˆ";
            }
            if (typeof val === 'number') {
                if (OKU_COLS.includes(h)) val = parseFloat((val / 100000000).toFixed(2));
                else if (PERCENT_COLS.includes(h)) val = parseFloat(((val < 1 && val > -1) ? val * 100 : val).toFixed(2));
                else val = parseFloat(val.toFixed(2));
            }
            newRow[h] = val;
        });
        return newRow;
    });

    const params = new URLSearchParams(window.location.search);
    const visibleCols = params.get('cols') ? params.get('cols').split(',') : INITIAL_VISIBLE;
    const marketCapIdx = headers.indexOf('æ™‚ä¾¡ç·é¡');

    headers.forEach((h, i) => {
        $('#tableHeader').append(`<th>${h}</th>`);
        if (SELECT_COLS.includes(h) || h === 'æ±ºç®—æœˆ') {
            let options = [...new Set(data.map(d => d[h]))].filter(Boolean);
            h === 'æ±ºç®—æœˆ' ? options.sort((a,b)=>parseInt(a)-parseInt(b)) : options.sort();
            let selectHtml = `<div class="search-item" data-type="select" data-col-idx="${i}" data-key="${h}"><label>${h}</label><select class="form-select form-select-sm select-input"><option value="">å…¨ã¦</option>`;
            options.forEach(opt => { selectHtml += `<option value="${opt}" ${params.get(h) === String(opt) ? 'selected' : ''}>${opt}</option>`; });
            $('#searchInputs').append(selectHtml + `</select></div>`);
        } else if (TEXT_SEARCH_COLS.includes(h)) {
            $('#searchInputs').append(`<div class="search-item" data-type="text" data-col-idx="${i}" data-key="${h}"><label>${h}</label><input type="text" class="form-control form-control-sm text-input" value="${params.get(h)||''}" placeholder="æ¤œç´¢"></div>`);
        } else if (typeof data[0][h] === 'number') {
            $('#searchInputs').append(`<div class="search-item" data-type="range" data-col-idx="${i}" data-key="${h}"><label>${h}${OKU_COLS.includes(h)?'(å„„)':(PERCENT_COLS.includes(h)?'(%)':'')}</label><div class="range-inputs d-flex gap-1"><input type="number" step="any" class="form-control form-control-sm min-input" value="${params.get(h+'_min')||''}" placeholder="æœ€å°"><input type="number" step="any" class="form-control form-control-sm max-input" value="${params.get(h+'_max')||''}" placeholder="æœ€å¤§"></div></div>`);
        }
        const active = visibleCols.includes(h) ? 'btn-primary' : 'btn-outline-secondary';
        $('#columnToggles').append(`<button class="btn ${active} btn-sm col-btn" data-column="${i}" data-name="${h}">${h}</button>`);
    });

    $('#loading').hide();
    $('#tableWrapper').show();

    table = $('#stockTable').DataTable({
        data: data,
        columns: headers.map(h => {
            const isVisible = visibleCols.includes(h);
            if (h === 'ä¼šç¤¾å') return { data: h, visible: isVisible, render: (d, t, r) => {
                const displayName = window.innerWidth < 768 ? d.substring(0, 4) : d;
                return `<a href="https://finance.yahoo.co.jp/quote/${r['éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰']}.T" target="_blank" class="stock-link"><span class="company-name-cell">${displayName}</span></a>`;
            } };
            return { data: h, visible: isVisible, defaultContent: "-" };
        }),
        language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" },
        scrollX: true,
        fixedColumns: { leftColumns: 1 },
        pageLength: 50,
        dom: 'rtip',
        autoWidth: false,
        order: marketCapIdx !== -1 ? [[marketCapIdx, 'desc']] : []
    });

    $('.text-input, .select-input, .min-input, .max-input').on('keyup change', function() {
        const $item = $(this).closest('.search-item');
        const idx = $item.data('col-idx');
        if($item.data('type') === 'select') table.column(idx).search(this.value ? '^' + $.fn.dataTable.util.escapeRegex(this.value) + '$' : '', true, false);
        else if($item.data('type') === 'text') table.column(idx).search(this.value);
        table.draw();
        updateURL();
    });

    $('.col-btn').on('click', function() {
        const idx = $(this).data('column');
        const col = table.column(idx);
        const vis = !col.visible();
        col.visible(vis);
        $(this).toggleClass('btn-primary', vis).toggleClass('btn-outline-secondary', !vis);
        table.columns.adjust().draw(false);
        updateURL();
    });
}

function updateURL() {
    const params = new URLSearchParams();
    $('.search-item').each(function() {
        const key = $(this).data('key');
        if ($(this).data('type') === 'range') {
            const min = $(this).find('.min-input').val();
            const max = $(this).find('.max-input').val();
            if(min) params.set(key + '_min', min);
            if(max) params.set(key + '_max', max);
        } else {
            const val = $(this).find('.text-input, .select-input').val();
            if(val) params.set(key, val);
        }
    });
    const activeCols = [];
    $('.col-btn.btn-primary').each(function() { activeCols.push($(this).data('name')); });
    params.set('cols', activeCols.join(','));
    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
}

function clearFilters() { window.location.href = window.location.pathname; }
function copyURL() { navigator.clipboard.writeText(window.location.href).then(() => alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")); }
</script>
</body>
</html>
